# jellyfin2pve

Terraform + Ansible deployment of Jellyfin media server in a Proxmox LXC container. Provisions a privileged Debian Trixie container with dual network interfaces, NFS mounts, and Intel GPU passthrough for hardware transcoding.

## What This Does

1. **Terraform**: 
   - Creates LXC container
   - Configures LXC firewall rules 
   - Generates Ansible inventory
2. **Ansible**: 
   - Mounts NFS on PVE host
   - Bind NFS mounts to container
   - Passes through GPU
   - Installs Jellyfin

## Prerequisites

- On your local PC:
  - Terraform
  - Ansible
- On the remote node:
  - Proxmox VE server with SSH and API access (tested on 8.4.14)
  - Debian Trixie LXC template stored on PVE node
  - Access to NFS server with two exports (video and music)

## Remote Access Setup

Before running Terraform, let's setup remote access to PVE.

### 1. SSH Key Setup

On your Terraform client, generate an SSH keypair (if you don't have one already):

```bash
ssh-keygen -t ed25519 -C "your_email@example.com"
```

Copy your public key to the Proxmox host:

```bash
ssh-copy-id root@YOUR_PROXMOX_IP
```

Verify SSH access works:

```bash
ssh root@YOUR_PROXMOX_IP
```

### 2. Proxmox API Token

Create an API token via Proxmox web UI:

1. Navigate to **Datacenter > Permissions > API Tokens**
2. Click **Add**
3. Settings:
   - User: `root@pam`
   - Token ID: `terraform`
   - **Uncheck** "Privilege Separation"
4. Copy the token secret immediately (format: `root@pam!terraform=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`)

Alternatively, via CLI on Proxmox host:

```bash
pveum user token add root@pam terraform --privsep 0
```

### 3. Download LXC Template

On your Proxmox host:

```bash
pveam update
pveam download local "debian-13-standard_13.1-2_amd64.tar.zst"

# Verify download
pveam list local
```

Note `debian-13-standard_13.1-2_amd64.tar.zst` is the container image specified as default in `variables.tf`. If you wish to use another image, update your `terraform.tfvars` accordingly.

## Deployment

### 1. Configure Variables

Create `terraform.tfvars` from the template:

```bash
cp terraform.tfvars.template terraform.tfvars
```
The template offers a subset of the variables defined in `variables.tf`. The file is well documented, if you want to further customize your `terraform.tfvars`.

Edit `terraform.tfvars` with your configuration:

```hcl
# Proxmox connection
proxmox_endpoint = "https://your-pve-host:8006"
proxmox_node     = "pve"

# Container settings
container_id       = 100
container_hostname = "jellyfin"

# Network
iface_a_bridge  = "vmbr0"
iface_a_ip      = "192.168.1.100/24"
iface_a_vlan    = 10
iface_a_gateway = "192.168.1.1"

# Optional: secondary interface
iface_b_bridge = "vmbr1"
iface_b_ip     = "10.0.0.100/24"
# iface_b_gateway = null  # Only one gateway allowed

# NFS configuration
nfs_server_ip     = "192.168.1.10"
nfs_export_video  = "/export/video"
nfs_export_music  = "/export/music"
nfs_mnt_dir_video = "/mnt/media/video"
nfs_mnt_dir_music = "/mnt/media/music"

# Secrets (keep these sensitive)
proxmox_api_token       = "root@pam!terraform=YOUR-TOKEN-SECRET"
container_root_password = "YOUR-SECURE-PASSWORD"
container_ssh_keys = [
  "ssh-ed25519 AAAAC3... user@host"
]
```

### Notes

- The config supports optional dual interfaces:
  - **Interface A** (eth0): Required, primary interface
  - **Interface B** (eth1): Optional, enabled when both `iface_b_bridge` and `iface_b_ip` are set
- Only one interface can have a gateway. This is enforced via lifecycle precondition.
- Container runs in **privileged mode** to allow GPU passthrough.
- `terraform.tfvars` is git-ignored as it contains secrets.

### 2. Initialize and Deploy

```bash
# Initialize Terraform
terraform init

# Preview changes
terraform plan

# Deploy infrastructure
terraform apply
```

### 3. Run Ansible Configuration

By default, `variables.tf` defines `ansible_auto_execute = true`. This runs an Ansible playbook automatically after provisioning.

To run manually:

```bash
cd ansible
ansible-playbook deploy-jellyfin.yml
```
Note this relies on `ansible/inventory/hosts.yml`, which is auto-generated by Terraform.

The playbook will:
1. Connecto to PVE via SSH
2. Mount NFS exports on PVE host using systemd automount
3. Bind-mount them into the container
4. Pass through Intel GPU devices
5. Start the container
6. Connect to the LXC via SSH directly and install Jellyfin

The NFS shares are configured using **systemd automount units** on the PVE host:
- Waits for network availability before attempting mounts
- NFS shares are only mounted when first accessed, not at boot time


### 4. Access Jellyfin

Once deployed, access Jellyfin at:

```
http://<container_ip>:8096
```

Complete the Jellyfin first-time setup wizard.

## Post-Deployment

### Enable Firewall

Terraform creates firewall rules on the container but doesn't enable the firewall. Enable it in the Proxmox web UI:

1. Select your container
2. Go to **Firewall > Options**
3. Enable the firewall

### Enable GPU acceleration in Jellyfin

Jellyfin need to be setup to use GPU acceleration. Log in as a Jellyfin admin, go to `Dashboard > Playback > Transcoding`. Under **Video Acceleration**, select option **VAAPI**. Then hit **Save** at the bottom of the page.

## Troubleshooting

### Verify GPU Passthrough

These commands work on both host and container:
```bash
ls -la /dev/dri/
# expected output
total 0
drwxr-xr-x  3 root root        100 Dec 11 09:48 .
drwxr-xr-x 19 root root       5240 Dec 11 09:50 ..
drwxr-xr-x  2 root root         80 Dec 11 09:48 by-path
crw-rw----  1 root video  226,   0 Dec 11 09:48 card0
crw-rw----  1 root render 226, 128 Dec 11 09:48 renderD128

# Intel GPU capabilities
vainfo  
# Live GPU utilization 
intel_gpu_top 
```

### Verify NFS Mounts

Inside the container:

```bash
df -h | grep nfs
ls -la <mount-path>
```

### Ansible Inventory Not Found

The inventory file is auto-generated by Terraform. If missing, run:

```bash
terraform apply -var-file="terraform.tfvars" -auto-approve
```

## Test environment

This workflow was tested on the following setup:

- Proxmox VE 8.4.14
- Intel Core i7 1265U CPU
- Intel Iris Xe Graphics max 1.25GHz
